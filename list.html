<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta charset="UTF-8" />
  <title>Ù„ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: 'BYekan', sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
      text-align: center;
    }
    #balanceDisplay {
      font-weight: bold;
      margin-bottom: 20px;
      font-size: 18px;
      text-align: center;
    }
    #statusMessage {
      text-align: center;
      margin-bottom: 15px;
      color: green;
      font-weight: bold;
      display: none;
    }
    #searchInput {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px auto;
      display: block;
      padding: 10px 15px;
      font-size: 16px;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    #searchInput:focus {
      outline: none;
      border-color: #2196F3;
    }
    .service-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 15px;
      transition: 0.3s;
    }
    .service-card.inactive {
      opacity: 0.5;
    }
    .service-title {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: bold;
      word-break: break-word;
    }
    .service-info {
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
    }
    .buttons {
      display: flex;
      justify-content: flex-start; /* Ø¨Ù‡ Ø¬Ø§ÛŒ space-between */
      align-items: center;
      gap: 10px;
    }
    .buttons .left-buttons {
      display: flex;
      gap: 8px;
    }
    .buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-renew {
      background-color: #4CAF50;
      color: white;
    }
    .btn-delete {
      background-color: #f44336;
      color: white;
    }
    .btn-view {
      background-color: #2196F3;
      color: white;
    }
    #pagination {
      text-align: center;
      margin-top: 20px;
    }
    #pagination button {
      margin: 0 5px;
      padding: 6px 12px;
      border: 1px solid #ccc;
      background-color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    #pagination button.active {
      background-color: #2196F3;
      color: white;
      border-color: #2196F3;
    }
    #pagination button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
      #messageBox {
      color: red;
      font-size: 15px;
      margin-bottom: 10px;
      min-height: 20px;
    }

    .btn-status {
     padding: 6px 12px;
     border: none;
     border-radius: 6px;
     font-size: 14px;
     cursor: pointer;
     color: white;
     min-width: 90px;
     text-align: center;
   }
   .btn-status.active {
     background-color: #4CAF50; /* Ø³Ø¨Ø² */
   }
   .btn-status.inactive {
     background-color: #f44336; /* Ù‚Ø±Ù…Ø² */
   }

  </style>
</head>
<body>

  <h2>Ù„ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§</h2>
  <div id="balanceDisplay">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ...</div>
  <div id="messageBox"></div>
  <div id="statusMessage"></div>

  <input
    type="text"
    id="searchInput"
    placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..."
    autocomplete="off"
  />

  <div id="servicesContainer">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§...</div>
  <div id="pagination"></div>

  <script>

    Telegram.WebApp.ready();

    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡
    Telegram.WebApp.expand();

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const user_id = getQueryParam("user_id");
    console.log("User ID from URL:", user_id);

    function bytesToGB(bytes) {
      return (bytes / (1024 ** 3)).toFixed(2);
    }

    function calculateExpireDays(expiryTimestamp) {
    if (!expiryTimestamp || isNaN(expiryTimestamp)) {
      // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Û³Û° Ø±ÙˆØ² Ù¾ÛŒØ´ ÙØ±Ø¶ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ (ÛŒØ¹Ù†ÛŒ Û³Û° Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø² Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†)
      return 30;
    }

    const absExpiry = Math.abs(expiryTimestamp);
    const now = Date.now();
    const diff = absExpiry - now;

    const oneDayMs = 1000 * 60 * 60 * 24;

    return diff > 0 ? Math.ceil(diff / oneDayMs) : 0;
  }




    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let servicesData = [];
    let filteredData = [];

    function showStatusMessage(message, isError = false) {
      const msgDiv = document.getElementById('statusMessage');
      msgDiv.innerText = message;
      msgDiv.style.color = isError ? 'red' : 'green';
      msgDiv.style.display = 'block';

      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 3000);
    }

    async function loadServices(userId) {
  try {
    const response = await fetch(`/list_users?user_id=${userId}`);
    const data = await response.json();

    // ğŸ‘ˆ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯Ø§ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    const bal = Number(data.balance);
    if (!isNaN(bal)) {
      document.getElementById('balanceDisplay').innerText =
        'Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ' + bal.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
    } else {
      document.getElementById('balanceDisplay').innerText = '';
    }

    // ğŸ‘ˆ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    const clients = Array.isArray(data.clients) ? data.clients : [];

    if (clients.length > 0) {
      servicesData = clients;
      filteredData = servicesData;
      currentPage = 1;
      renderPage(currentPage);
      renderPagination();
    } else {
      document.getElementById('servicesContainer').innerText = 'Ø´Ù…Ø§ Ø³Ø±ÙˆÛŒØ³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.';
      document.getElementById('pagination').innerHTML = '';
    }

  } catch (error) {
    // ğŸ‘ˆ Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¨ÙˆØ¯ØŒ ÙÙ‚Ø· Ø¨Ú¯Ùˆ Ø³Ø±ÙˆÛŒØ³ÛŒ Ù†ÛŒØ³Øª. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ùˆ Ø¯Ø³Øª Ù†Ø²Ù†
    document.getElementById('servicesContainer').innerText = 'Ø´Ù…Ø§ Ø³Ø±ÙˆÛŒØ³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.';
    document.getElementById('pagination').innerHTML = '';
  }
}

function renderServices(services) {
  const container = document.getElementById('servicesContainer');
  container.innerHTML = '';
    
  if (services.length === 0) {
    container.innerText = 'Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
    return;
  }

  services.forEach(service => {
    const usedBytes = service.up + service.down;
    const usedGB = bytesToGB(usedBytes);
    const totalGB = bytesToGB(service.total);
    const remainingGB = totalGB - usedGB;
    const expireDays = calculateExpireDays(service.mytime);
    const expireText = expireDays > 0 ? `${expireDays} Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡` : 'Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡';
    // const showRenew = (expireDays <= 5 && expireDays > 0) || remainingGB < 5; 
    const showRenew =true
   
    //////////////less than volume and expire

    const card = document.createElement('div');
    card.className = 'service-card';
    if (expireDays <= 0) card.classList.add('inactive');

    card.innerHTML = `
      <div class="service-title">${service.email}</div>
      <div class="service-info">Ø­Ø¬Ù… Ú©Ù„: ${totalGB} Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª</div>
      <div class="service-info">Ø­Ø¬Ù… Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${usedGB} Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª</div>
      <div class="service-info">Ø§Ù†Ù‚Ø¶Ø§: ${expireText}</div>
      <div class="service-info" style="color: #000; font-weight: bold; font-size: 16px;">
        Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: ${service.comment ? service.comment : 'Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø±'}
      </div>
      <div class="buttons">
        <button class="btn-view" onclick="viewService(${service.id})">Ù†Ù…Ø§ÛŒØ´</button>
        ${showRenew ? `<button class="btn-renew" onclick="renewService(${service.id})">ØªÙ…Ø¯ÛŒØ¯</button>` : ''}
        <button class="btn-delete" onclick="deleteService(${service.id})">Ø­Ø°Ù</button>
      </div>
    `;

    container.appendChild(card);
  });
}

    function renderPage(page) {
      const start = (page - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageItems = filteredData.slice(start, end);
      renderServices(pageItems);
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let buttonsHTML = '';

      buttonsHTML += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Ù‚Ø¨Ù„ÛŒ</button>`;

      for (let i = 1; i <= totalPages; i++) {
        buttonsHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
      }

      buttonsHTML += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Ø¨Ø¹Ø¯ÛŒ</button>`;

      pagination.innerHTML = buttonsHTML;
    }

    function changePage(page) {
      if (page < 1 || page > Math.ceil(filteredData.length / ITEMS_PER_PAGE)) return;
      currentPage = page;
      renderPage(page);
      renderPagination();
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    async function renewService(id) {
    const selectedService = servicesData.find(service => String(service.id) === String(id));

    if (!selectedService) {
      console.error("Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯:", id);
      return;
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± sessionStorage
    sessionStorage.setItem('selectedService', JSON.stringify(selectedService));
    sessionStorage.setItem('user_id', user_id);
    // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
    window.location.href = '/update.html';
  }
    function viewService(id) {
    const selectedService = servicesData.find(service => String(service.id) === String(id));

    if (!selectedService) {
      console.error('Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ø§ÛŒÙ† ID Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯:', id);
      return;
    }

    fetch('/show_services', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        service: selectedService,
        user_id: user_id
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
      }
      return response.json();
    })
    .then(data => {
      console.log('Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', data);

      // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: Ø§Ú¯Ø± Ø¬ÙˆØ§Ø¨ Ø³Ø±ÙˆØ± Ø´Ø§Ù…Ù„ close_app Ø¨ÙˆØ¯ØŒ Ø§Ù¾ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ùˆ Ø¨Ø¨Ù†Ø¯
      if (data.close_app) {
        setTimeout(() => {
          Telegram.WebApp.close();
        }, 500);
      }
    })
    .catch(error => {
      console.error('Ø®Ø·Ø§:', error);
    });
  }



  async function deleteService(id) {
  if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³Ø±ÙˆÛŒØ³ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
  const selectedService = servicesData.find(service => String(service.id) === String(id));

  if (!selectedService) {
    console.error("Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯:", id);
    return;
  }

  try {
    const response = await fetch('/delete_service', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        service: selectedService,
        user_id: user_id  // ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ†Ú©Ù‡ user_id Ø§Ø² URL Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡
      }),
    });

    const result = await response.json();

    if (response.ok && result.Status === 'success') {
      // Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ù¾ÛŒØ§Ù… Ùˆ Ù…Ø¨Ù„Øº Ø¨Ø§ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù† ÙØ§Ø±Ø³ÛŒ
      let message = result.message || '';
      const regex = /([0-9,.]+)/; // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¹Ø¯Ø¯ Ø¯Ø± Ù¾ÛŒØ§Ù…
      const match = message.match(regex);

      if (match) {
        const rawNumber = parseFloat(match[1].replace(/,/g, ''));
        const formatted = Number.isInteger(rawNumber)
          ? rawNumber.toLocaleString('en-US')
          : rawNumber.toLocaleString('en-US', { minimumFractionDigits: 1 });
        message = message.replace(match[1], formatted);
      }

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ù„Ø§Ù…Øª ØªÛŒÚ© Ø³Ø¨Ø² Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯
      if (!message.includes('âœ…')) {
        message = 'âœ… ' + message;
      }

      // Ø­Ø°Ù Ù†Ù‚Ø·Ù‡ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…
      message = message.trim().replace(/[.]+$/, '');

      // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø§ alert
      alert(message);

      // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØµÙØ­Ù‡
      const bal = Number(result.balance);
      if (!isNaN(bal)) {
        document.getElementById('balanceDisplay').innerText =
          'Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ' + bal.toLocaleString('en-US') + ' ØªÙˆÙ…Ø§Ù†';
      }

      // Ø­Ø°Ù Ø³Ø±ÙˆÛŒØ³ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ
      servicesData = servicesData.filter(service => service.id !== id);
      filteredData = filteredData.filter(service => service.id !== id);

      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØµÙØ­Ù‡
      if (filteredData.length === 0 && currentPage > 1) {
        currentPage--;
      }
      renderPage(currentPage);
      renderPagination();

      // Ø¨Ø³ØªÙ† Ø§Ù¾ Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨ÙˆØ¯
      if (result.close_app) {
        setTimeout(() => {
          Telegram.WebApp.close();
        }, 500);
      }

    } else {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆÛŒØ³: ' + (result.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
    }

  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆÛŒØ³:', error);
    alert('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
  }
}
    document.getElementById('searchInput').addEventListener('input', (e) => {
    const searchText = e.target.value.trim().toLowerCase();
    filteredData = servicesData.filter(service =>
      service.email.toLowerCase().includes(searchText) ||
      (service.comment && service.comment.toLowerCase().includes(searchText))
    );
    currentPage = 1;
    renderPage(currentPage);
    renderPagination();
    });

    if (user_id) {
      loadServices(user_id);
    } else {
      document.getElementById('balanceDisplay').innerText = 'Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.';
      document.getElementById('servicesContainer').innerText = '';
    }
  </script>
</body>
</html>
